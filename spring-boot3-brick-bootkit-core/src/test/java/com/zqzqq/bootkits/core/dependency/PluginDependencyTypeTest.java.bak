package com.zqzqq.bootkits.core.dependency;

import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import static org.assertj.core.api.Assertions.assertThat;

/**
 * 插件依赖类型测试
 */
@DisplayName("PluginDependencyType Test")
class PluginDependencyTypeTest {

    @Test
    @DisplayName("测试所有依赖类型枚举值")
    void testAllDependencyTypeValues() {
        assertThat(PluginDependencyType.values()).containsExactly(
            PluginDependencyType.REQUIRED,
            PluginDependencyType.OPTIONAL,
            PluginDependencyType.PROVIDED,
            PluginDependencyType.TEST,
            PluginDependencyType.RUNTIME,
            PluginDependencyType.SYSTEM
        );
    }

    @Test
    @DisplayName("测试依赖类型的基本属性")
    void testDependencyTypeBasicProperties() {
        // 测试 REQUIRED 类型
        assertThat(PluginDependencyType.REQUIRED.getName()).isEqualTo("REQUIRED");
        assertThat(PluginDependencyType.REQUIRED.getDescription()).isEqualTo("必需依赖");
        assertThat(PluginDependencyType.REQUIRED.isRequired()).isTrue();
        assertThat(PluginDependencyType.REQUIRED.isOptional()).isFalse();
        assertThat(PluginDependencyType.REQUIRED.isTransitive()).isTrue();

        // 测试 OPTIONAL 类型
        assertThat(PluginDependencyType.OPTIONAL.getName()).isEqualTo("OPTIONAL");
        assertThat(PluginDependencyType.OPTIONAL.getDescription()).isEqualTo("可选依赖");
        assertThat(PluginDependencyType.OPTIONAL.isRequired()).isFalse();
        assertThat(PluginDependencyType.OPTIONAL.isOptional()).isTrue();
        assertThat(PluginDependencyType.OPTIONAL.isTransitive()).isFalse();

        // 测试 PROVIDED 类型
        assertThat(PluginDependencyType.PROVIDED.getName()).isEqualTo("PROVIDED");
        assertThat(PluginDependencyType.PROVIDED.getDescription()).isEqualTo("提供者依赖");
        assertThat(PluginDependencyType.PROVIDED.isRequired()).isTrue();
        assertThat(PluginDependencyType.PROVIDED.isOptional()).isFalse();
        assertThat(PluginDependencyType.PROVIDED.isTransitive()).isFalse();

        // 测试 TEST 类型
        assertThat(PluginDependencyType.TEST.getName()).isEqualTo("TEST");
        assertThat(PluginDependencyType.TEST.getDescription()).isEqualTo("测试依赖");
        assertThat(PluginDependencyType.TEST.isRequired()).isFalse();
        assertThat(PluginDependencyType.TEST.isOptional()).isTrue();
        assertThat(PluginDependencyType.TEST.isTransitive()).isFalse();

        // 测试 RUNTIME 类型
        assertThat(PluginDependencyType.RUNTIME.getName()).isEqualTo("RUNTIME");
        assertThat(PluginDependencyType.RUNTIME.getDescription()).isEqualTo("运行时依赖");
        assertThat(PluginDependencyType.RUNTIME.isRequired()).isTrue();
        assertThat(PluginDependencyType.RUNTIME.isOptional()).isFalse();
        assertThat(PluginDependencyType.RUNTIME.isTransitive()).isTrue();

        // 测试 SYSTEM 类型
        assertThat(PluginDependencyType.SYSTEM.getName()).isEqualTo("SYSTEM");
        assertThat(PluginDependencyType.SYSTEM.getDescription()).isEqualTo("系统依赖");
        assertThat(PluginDependencyType.SYSTEM.isRequired()).isTrue();
        assertThat(PluginDependencyType.SYSTEM.isOptional()).isFalse();
        assertThat(PluginDependencyType.SYSTEM.isTransitive()).isFalse();
    }

    @Test
    @DisplayName("测试依赖类型的枚举序")
    void testDependencyTypeEnumOrder() {
        // 验证枚举定义的顺序
        PluginDependencyType[] types = PluginDependencyType.values();
        
        assertThat(types[0]).isEqualTo(PluginDependencyType.REQUIRED);
        assertThat(types[1]).isEqualTo(PluginDependencyType.OPTIONAL);
        assertThat(types[2]).isEqualTo(PluginDependencyType.PROVIDED);
        assertThat(types[3]).isEqualTo(PluginDependencyType.TEST);
        assertThat(types[4]).isEqualTo(PluginDependencyType.RUNTIME);
        assertThat(types[5]).isEqualTo(PluginDependencyType.SYSTEM);
    }

    @Test
    @DisplayName("测试依赖类型的字符串表示")
    void testDependencyTypeStringRepresentation() {
        assertThat(PluginDependencyType.REQUIRED.name()).isEqualTo("REQUIRED");
        assertThat(PluginDependencyType.OPTIONAL.name()).isEqualTo("OPTIONAL");
        assertThat(PluginDependencyType.PROVIDED.name()).isEqualTo("PROVIDED");
        assertThat(PluginDependencyType.TEST.name()).isEqualTo("TEST");
        assertThat(PluginDependencyType.RUNTIME.name()).isEqualTo("RUNTIME");
        assertThat(PluginDependencyType.SYSTEM.name()).isEqualTo("SYSTEM");
    }

    @Test
    @DisplayName("测试依赖类型的toString方法")
    void testDependencyTypeToString() {
        assertThat(PluginDependencyType.REQUIRED.toString()).isEqualTo("REQUIRED (必需依赖)");
        assertThat(PluginDependencyType.OPTIONAL.toString()).isEqualTo("OPTIONAL (可选依赖)");
        assertThat(PluginDependencyType.PROVIDED.toString()).isEqualTo("PROVIDED (提供者依赖)");
        assertThat(PluginDependencyType.TEST.toString()).isEqualTo("TEST (测试依赖)");
        assertThat(PluginDependencyType.RUNTIME.toString()).isEqualTo("RUNTIME (运行时依赖)");
        assertThat(PluginDependencyType.SYSTEM.toString()).isEqualTo("SYSTEM (系统依赖)");
    }

    @Test
    @DisplayName("测试依赖类型的值方法")
    void testDependencyTypeValueMethod() {
        assertThat(PluginDependencyType.REQUIRED.value()).isEqualTo("required");
        assertThat(PluginDependencyType.OPTIONAL.value()).isEqualTo("optional");
        assertThat(PluginDependencyType.PROVIDED.value()).isEqualTo("provided");
        assertThat(PluginDependencyType.TEST.value()).isEqualTo("test");
        assertThat(PluginDependencyType.RUNTIME.value()).isEqualTo("runtime");
        assertThat(PluginDependencyType.SYSTEM.value()).isEqualTo("system");
    }

    @Test
    @DisplayName("测试从字符串创建依赖类型")
    void testCreateDependencyTypeFromString() {
        // 测试不区分大小写的转换
        assertThat(PluginDependencyType.fromString("REQUIRED")).isEqualTo(PluginDependencyType.REQUIRED);
        assertThat(PluginDependencyType.fromString("required")).isEqualTo(PluginDependencyType.REQUIRED);
        assertThat(PluginDependencyType.fromString("Required")).isEqualTo(PluginDependencyType.REQUIRED);

        assertThat(PluginDependencyType.fromString("OPTIONAL")).isEqualTo(PluginDependencyType.OPTIONAL);
        assertThat(PluginDependencyType.fromString("optional")).isEqualTo(PluginDependencyType.OPTIONAL);

        assertThat(PluginDependencyType.fromString("PROVIDED")).isEqualTo(PluginDependencyType.PROVIDED);
        assertThat(PluginDependencyType.fromString("provided")).isEqualTo(PluginDependencyType.PROVIDED);

        // 测试所有类型的转换
        assertThat(PluginDependencyType.fromString("TEST")).isEqualTo(PluginDependencyType.TEST);
        assertThat(PluginDependencyType.fromString("RUNTIME")).isEqualTo(PluginDependencyType.RUNTIME);
        assertThat(PluginDependencyType.fromString("SYSTEM")).isEqualTo(PluginDependencyType.SYSTEM);
    }

    @Test
    @DisplayName("测试无效字符串的依赖类型创建")
    void testCreateDependencyTypeWithInvalidString() {
        assertThat(PluginDependencyType.fromString("INVALID")).isNull();
        assertThat(PluginDependencyType.fromString("unknown")).isNull();
        assertThat(PluginDependencyType.fromString("")).isNull();
        assertThat(PluginDependencyType.fromString("   ")).isNull();
        assertThat(PluginDependencyType.fromString(null)).isNull();
    }

    @Test
    @DisplayName("测试依赖类型的必需性判断")
    void testDependencyTypeRequirementJudgement() {
        // 测试必需依赖
        assertThat(PluginDependencyType.REQUIRED.isRequired()).isTrue();
        assertThat(PluginDependencyType.PROVIDED.isRequired()).isTrue();
        assertThat(PluginDependencyType.RUNTIME.isRequired()).isTrue();
        assertThat(PluginDependencyType.SYSTEM.isRequired()).isTrue();

        // 测试非必需依赖
        assertThat(PluginDependencyType.OPTIONAL.isRequired()).isFalse();
        assertThat(PluginDependencyType.TEST.isRequired()).isFalse();
    }

    @Test
    @DisplayName("测试依赖类型的可选性判断")
    void testDependencyTypeOptionalJudgement() {
        // 测试可选依赖
        assertThat(PluginDependencyType.OPTIONAL.isOptional()).isTrue();
        assertThat(PluginDependencyType.TEST.isOptional()).isTrue();

        // 测试非可选依赖
        assertThat(PluginDependencyType.REQUIRED.isOptional()).isFalse();
        assertThat(PluginDependencyType.PROVIDED.isOptional()).isFalse();
        assertThat(PluginDependencyType.RUNTIME.isOptional()).isFalse();
        assertThat(PluginDependencyType.SYSTEM.isOptional()).isFalse();
    }

    @Test
    @DisplayName("测试依赖类型的传递性判断")
    void testDependencyTypeTransitivityJudgement() {
        // 测试传递依赖
        assertThat(PluginDependencyType.REQUIRED.isTransitive()).isTrue();
        assertThat(PluginDependencyType.RUNTIME.isTransitive()).isTrue();

        // 测试非传递依赖
        assertThat(PluginDependencyType.OPTIONAL.isTransitive()).isFalse();
        assertThat(PluginDependencyType.PROVIDED.isTransitive()).isFalse();
        assertThat(PluginDependencyType.TEST.isTransitive()).isFalse();
        assertThat(PluginDependencyType.SYSTEM.isTransitive()).isFalse();
    }

    @Test
    @DisplayName("测试依赖类型的相等性")
    void testDependencyTypeEquality() {
        // 测试相等性
        assertThat(PluginDependencyType.REQUIRED).isEqualTo(PluginDependencyType.REQUIRED);
        assertThat(PluginDependencyType.OPTIONAL).isEqualTo(PluginDependencyType.OPTIONAL);

        // 测试不等性
        assertThat(PluginDependencyType.REQUIRED).isNotEqualTo(PluginDependencyType.OPTIONAL);
        assertThat(PluginDependencyType.PROVIDED).isNotEqualTo(PluginDependencyType.TEST);
    }

    @Test
    @DisplayName("测试依赖类型的哈希码")
    void testDependencyTypeHashCode() {
        assertThat(PluginDependencyType.REQUIRED.hashCode()).isEqualTo(PluginDependencyType.REQUIRED.hashCode());
        assertThat(PluginDependencyType.OPTIONAL.hashCode()).isEqualTo(PluginDependencyType.OPTIONAL.hashCode());
        
        // 不同类型的哈希码应该不同（大概率）
        assertThat(PluginDependencyType.REQUIRED.hashCode()).isNotEqualTo(PluginDependencyType.OPTIONAL.hashCode());
    }

    @Test
    @DisplayName("测试依赖类型在集合中的行为")
    void testDependencyTypeInCollections() {
        // 测试在HashSet中的行为
        java.util.Set<PluginDependencyType> typeSet = new java.util.HashSet<>();
        typeSet.add(PluginDependencyType.REQUIRED);
        typeSet.add(PluginDependencyType.OPTIONAL);
        typeSet.add(PluginDependencyType.REQUIRED); // 重复添加

        assertThat(typeSet).hasSize(2);
        assertThat(typeSet).containsExactlyInAnyOrder(PluginDependencyType.REQUIRED, PluginDependencyType.OPTIONAL);

        // 测试在ArrayList中的行为
        java.util.List<PluginDependencyType> typeList = new java.util.ArrayList<>();
        typeList.add(PluginDependencyType.PROVIDED);
        typeList.add(PluginDependencyType.TEST);
        typeList.add(PluginDependencyType.PROVIDED); // 重复添加

        assertThat(typeList).hasSize(3);
        assertThat(typeList.get(0)).isEqualTo(PluginDependencyType.PROVIDED);
        assertThat(typeList.get(1)).isEqualTo(PluginDependencyType.TEST);
        assertThat(typeList.get(2)).isEqualTo(PluginDependencyType.PROVIDED);
    }

    @Test
    @DisplayName("测试依赖类型的compareTo方法")
    void testDependencyTypeComparison() {
        // 测试自然顺序比较（基于枚举序）
        assertThat(PluginDependencyType.REQUIRED.compareTo(PluginDependencyType.OPTIONAL)).isNegative();
        assertThat(PluginDependencyType.OPTIONAL.compareTo(PluginDependencyType.REQUIRED)).isPositive();
        assertThat(PluginDependencyType.REQUIRED.compareTo(PluginDependencyType.REQUIRED)).isZero();

        assertThat(PluginDependencyType.PROVIDED.compareTo(PluginDependencyType.TEST)).isNegative();
        assertThat(PluginDependencyType.TEST.compareTo(PluginDependencyType.PROVIDED)).isPositive();
    }

    @Test
    @DisplayName("测试依赖类型的不可变性")
    void testDependencyTypeImmutability() {
        // 验证枚举的不可变性
        PluginDependencyType type = PluginDependencyType.REQUIRED;
        
        // 尝试修改应该失败或无效
        try {
            // 由于是枚举，实际上无法修改，这里主要是验证接口存在
            assertThat(type.getName()).isNotNull();
            assertThat(type.getDescription()).isNotNull();
            assertThat(type.value()).isNotNull();
            assertThat(type.isRequired()).isNotNull();
            assertThat(type.isOptional()).isNotNull();
            assertThat(type.isTransitive()).isNotNull();
        } catch (Exception e) {
            // 枚举的不可变性保证了这不会发生
        }
    }

    @Test
    @DisplayName("测试依赖类型的语义正确性")
    void testDependencyTypeSemanticCorrectness() {
        // 验证每种依赖类型的语义正确性
        assertThat(PluginDependencyType.REQUIRED.isRequired()).isTrue();
        assertThat(PluginDependencyType.REQUIRED.isOptional()).isFalse();
        assertThat(PluginDependencyType.REQUIRED.isTransitive()).isTrue();

        assertThat(PluginDependencyType.OPTIONAL.isRequired()).isFalse();
        assertThat(PluginDependencyType.OPTIONAL.isOptional()).isTrue();
        assertThat(PluginDependencyType.OPTIONAL.isTransitive()).isFalse();

        assertThat(PluginDependencyType.PROVIDED.isRequired()).isTrue();
        assertThat(PluginDependencyType.PROVIDED.isOptional()).isFalse();
        assertThat(PluginDependencyType.PROVIDED.isTransitive()).isFalse();

        assertThat(PluginDependencyType.TEST.isRequired()).isFalse();
        assertThat(PluginDependencyType.TEST.isOptional()).isTrue();
        assertThat(PluginDependencyType.TEST.isTransitive()).isFalse();

        assertThat(PluginDependencyType.RUNTIME.isRequired()).isTrue();
        assertThat(PluginDependencyType.RUNTIME.isOptional()).isFalse();
        assertThat(PluginDependencyType.RUNTIME.isTransitive()).isTrue();

        assertThat(PluginDependencyType.SYSTEM.isRequired()).isTrue();
        assertThat(PluginDependencyType.SYSTEM.isOptional()).isFalse();
        assertThat(PluginDependencyType.SYSTEM.isTransitive()).isFalse();
    }
}