package com.zqzqq.bootkits.core.dependency;

import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

/**
 * æ’ä»¶å…¼å®¹æ€§ç»“æœæµ‹è¯•
 */
@DisplayName("PluginCompatibilityResult Test")
class PluginCompatibilityResultTest {

    @Test
    @DisplayName("æµ‹è¯•åˆ›å»ºå…¼å®¹ç»“æœ")
    void testCreateCompatibleResult() {
        List<String> warnings = Arrays.asList("Minor version mismatch");

        PluginCompatibilityResult result = PluginCompatibilityResult.compatible(warnings);

        assertThat(result.isCompatible()).isTrue();
        assertThat(result.getErrors()).isEmpty();
        assertThat(result.getWarnings()).isEqualTo(warnings);
    }

    @Test
    @DisplayName("æµ‹è¯•åˆ›å»ºå…¼å®¹ä½†æœ‰è­¦å‘Šçš„ç»“æœ")
    void testCreateCompatibleWithWarnings() {
        List<String> warnings = Arrays.asList(
            "Plugin version is outdated",
            "Consider upgrading dependencies"
        );

        PluginCompatibilityResult result = PluginCompatibilityResult.compatibleWithWarnings(warnings);

        assertThat(result.isCompatible()).isTrue();
        assertThat(result.getErrors()).isEmpty();
        assertThat(result.getWarnings()).isEqualTo(warnings);
    }

    @Test
    @DisplayName("æµ‹è¯•åˆ›å»ºä¸å…¼å®¹ç»“æœ")
    void testCreateIncompatibleResult() {
        List<String> errors = Arrays.asList(
            "Version conflict detected",
            "Missing required dependency"
        );

        PluginCompatibilityResult result = PluginCompatibilityResult.incompatible(errors);

        assertThat(result.isCompatible()).isFalse();
        assertThat(result.getErrors()).isEqualTo(errors);
        assertThat(result.getWarnings()).isEmpty();
    }

    @Test
    @DisplayName("æµ‹è¯•åˆ›å»ºä¸å…¼å®¹ä½†æœ‰è­¦å‘Šçš„ç»“æœ")
    void testCreateIncompatibleWithWarnings() {
        List<String> errors = Arrays.asList("Critical version conflict");
        List<String> warnings = Arrays.asList("Minor compatibility warning");

        PluginCompatibilityResult result = PluginCompatibilityResult.incompatibleWithWarnings(errors, warnings);

        assertThat(result.isCompatible()).isFalse();
        assertThat(result.getErrors()).isEqualTo(errors);
        assertThat(result.getWarnings()).isEqualTo(warnings);
    }

    @Test
    @DisplayName("æµ‹è¯•é™æ€å·¥å‚æ–¹æ³•")
    void testStaticFactoryMethods() {
        // æµ‹è¯• compatible æ–¹æ³•
        PluginCompatibilityResult result1 = PluginCompatibilityResult.compatible();
        assertThat(result1.isCompatible()).isTrue();
        assertThat(result1.getErrors()).isEmpty();

        PluginCompatibilityResult result2 = PluginCompatibilityResult.compatible(Arrays.asList("warning"));
        assertThat(result2.isCompatible()).isTrue();
        assertThat(result2.getWarnings()).containsExactly("warning");

        // æµ‹è¯• incompatible æ–¹æ³•
        PluginCompatibilityResult result3 = PluginCompatibilityResult.incompatible();
        assertThat(result3.isCompatible()).isFalse();
        assertThat(result3.getErrors()).isEmpty();

        PluginCompatibilityResult result4 = PluginCompatibilityResult.incompatible(Arrays.asList("error"));
        assertThat(result4.isCompatible()).isFalse();
        assertThat(result4.getErrors()).containsExactly("error");
    }

    @Test
    @DisplayName("æµ‹è¯•ç©ºå‚æ•°å¤„ç†")
    void testNullParameterHandling() {
        // æµ‹è¯•nullè­¦å‘Šåˆ—è¡¨
        PluginCompatibilityResult result1 = PluginCompatibilityResult.compatible(null);
        assertThat(result1.getWarnings()).isEmpty();

        // æµ‹è¯•nullé”™è¯¯åˆ—è¡¨
        PluginCompatibilityResult result2 = PluginCompatibilityResult.incompatible(null);
        assertThat(result2.getErrors()).isEmpty();

        // æµ‹è¯•nullé”™è¯¯å’Œè­¦å‘Šåˆ—è¡¨
        PluginCompatibilityResult result3 = PluginCompatibilityResult.incompatibleWithWarnings(null, null);
        assertThat(result3.getErrors()).isEmpty();
        assertThat(result3.getWarnings()).isEmpty();
    }

    @Test
    @DisplayName("æµ‹è¯•ä¸å¯å˜é›†åˆ")
    void testUnmodifiableCollections() {
        List<String> errors = Arrays.asList("error1", "error2");
        List<String> warnings = Arrays.asList("warning1", "warning2");

        PluginCompatibilityResult result = PluginCompatibilityResult.incompatibleWithWarnings(errors, warnings);

        // å°è¯•ä¿®æ”¹è¿”å›çš„é›†åˆåº”è¯¥å¤±è´¥
        assertThatThrownBy(() -> result.getErrors().add("new-error"))
            .isInstanceOf(UnsupportedOperationException.class);

        assertThatThrownBy(() -> result.getWarnings().add("new-warning"))
            .isInstanceOf(UnsupportedOperationException.class);
    }

    @Test
    @DisplayName("æµ‹è¯•å¤æ‚å…¼å®¹æ€§åœºæ™¯")
    void testComplexCompatibilityScenarios() {
        // åœºæ™¯1: å®Œå…¨å…¼å®¹
        PluginCompatibilityResult fullyCompatible = PluginCompatibilityResult.compatible();
        assertThat(fullyCompatible.isCompatible()).isTrue();
        assertThat(fullyCompatible.hasErrors()).isFalse();
        assertThat(fullyCompatible.hasWarnings()).isFalse();

        // åœºæ™¯2: å…¼å®¹ä½†æœ‰è­¦å‘Š
        List<String> minorWarnings = Arrays.asList(
            "Plugin uses deprecated API",
            "Version is one minor release behind"
        );
        PluginCompatibilityResult compatibleWithWarnings = PluginCompatibilityResult.compatibleWithWarnings(minorWarnings);
        assertThat(compatibleWithWarnings.isCompatible()).isTrue();
        assertThat(compatibleWithWarnings.hasErrors()).isFalse();
        assertThat(compatibleWithWarnings.hasWarnings()).isTrue();
        assertThat(compatibleWithWarnings.getWarnings()).hasSize(2);

        // åœºæ™¯3: ä¸å…¼å®¹
        List<String> criticalErrors = Arrays.asList(
            "Major version mismatch",
            "Incompatible dependency versions"
        );
        PluginCompatibilityResult incompatible = PluginCompatibilityResult.incompatible(criticalErrors);
        assertThat(incompatible.isCompatible()).isFalse();
        assertThat(incompatible.hasErrors()).isTrue();
        assertThat(incompatible.hasWarnings()).isFalse();
        assertThat(incompatible.getErrors()).hasSize(2);

        // åœºæ™¯4: ä¸å…¼å®¹ä½†æœ‰é¢å¤–è­¦å‘Š
        List<String> additionalWarnings = Arrays.asList("Some additional context");
        PluginCompatibilityResult incompatibleWithWarnings = PluginCompatibilityResult.incompatibleWithWarnings(criticalErrors, additionalWarnings);
        assertThat(incompatibleWithWarnings.isCompatible()).isFalse();
        assertThat(incompatibleWithWarnings.hasErrors()).isTrue();
        assertThat(incompatibleWithWarnings.hasWarnings()).isTrue();
        assertThat(incompatibleWithWarnings.getErrors()).hasSize(2);
        assertThat(incompatibleWithWarnings.getWarnings()).hasSize(1);
    }

    @Test
    @DisplayName("æµ‹è¯•å…¼å®¹æ€§ç»“æœçš„ä¸€è‡´æ€§")
    void testCompatibilityResultConsistency() {
        PluginCompatibilityResult compatible = PluginCompatibilityResult.compatible();
        PluginCompatibilityResult incompatible = PluginCompatibilityResult.incompatible();

        // éªŒè¯å…¼å®¹ç»“æœçš„ä¸€è‡´æ€§
        assertThat(compatible.isCompatible()).isTrue();
        assertThat(compatible.hasErrors()).isFalse();
        assertThat(compatible.hasWarnings()).isFalse();

        // éªŒè¯ä¸å…¼å®¹ç»“æœçš„ä¸€è‡´æ€§
        assertThat(incompatible.isCompatible()).isFalse();
        assertThat(incompatible.hasErrors()).isFalse(); // ç©ºé”™è¯¯åˆ—è¡¨
        assertThat(incompatible.hasWarnings()).isFalse();
    }

    @Test
    @DisplayName("æµ‹è¯•å¤§é‡é”™è¯¯å’Œè­¦å‘Šå¤„ç†")
    void testLargeNumberOfErrorsAndWarnings() {
        // æµ‹è¯•å¤§é‡é”™è¯¯
        List<String> manyErrors = new ArrayList<>();
        for (int i = 0; i < 1000; i++) {
            manyErrors.add("Error " + i);
        }

        PluginCompatibilityResult resultWithManyErrors = PluginCompatibilityResult.incompatible(manyErrors);
        assertThat(resultWithManyErrors.isCompatible()).isFalse();
        assertThat(resultWithManyErrors.getErrors()).hasSize(1000);
        assertThat(resultWithManyErrors.getErrors().get(0)).isEqualTo("Error 0");
        assertThat(resultWithManyErrors.getErrors().get(999)).isEqualTo("Error 999");

        // æµ‹è¯•å¤§é‡è­¦å‘Š
        List<String> manyWarnings = new ArrayList<>();
        for (int i = 0; i < 500; i++) {
            manyWarnings.add("Warning " + i);
        }

        PluginCompatibilityResult resultWithManyWarnings = PluginCompatibilityResult.compatibleWithWarnings(manyWarnings);
        assertThat(resultWithManyWarnings.isCompatible()).isTrue();
        assertThat(resultWithManyWarnings.getWarnings()).hasSize(500);
        assertThat(resultWithManyWarnings.getWarnings().get(0)).isEqualTo("Warning 0");
        assertThat(resultWithManyWarnings.getWarnings().get(499)).isEqualTo("Warning 499");
    }

    @Test
    @DisplayName("æµ‹è¯•å…¼å®¹æ€§ç»“æœçš„å¤åˆ¶")
    void testCompatibilityResultCopying() {
        List<String> originalErrors = Arrays.asList("error1", "error2");
        List<String> originalWarnings = Arrays.asList("warning1", "warning2");

        PluginCompatibilityResult original = PluginCompatibilityResult.incompatibleWithWarnings(originalErrors, originalWarnings);

        // åˆ›å»ºå‰¯æœ¬
        List<String> copiedErrors = new ArrayList<>(original.getErrors());
        List<String> copiedWarnings = new ArrayList<>(original.getWarnings());

        // ä¿®æ”¹å‰¯æœ¬ä¸å½±å“åŸå§‹å¯¹è±¡
        copiedErrors.add("error3");
        copiedWarnings.add("warning3");

        assertThat(original.getErrors()).hasSize(2);
        assertThat(original.getWarnings()).hasSize(2);
        assertThat(copiedErrors).hasSize(3);
        assertThat(copiedWarnings).hasSize(3);
    }

    @Test
    @DisplayName("æµ‹è¯•å…¼å®¹æ€§ç»“æœçš„è¿­ä»£")
    void testCompatibilityResultIteration() {
        List<String> errors = Arrays.asList("error1", "error2", "error3");
        List<String> warnings = Arrays.asList("warning1", "warning2");

        PluginCompatibilityResult result = PluginCompatibilityResult.incompatibleWithWarnings(errors, warnings);

        // æµ‹è¯•è¿­ä»£é”™è¯¯åˆ—è¡¨
        int errorCount = 0;
        for (String error : result.getErrors()) {
            assertThat(error).isNotNull();
            errorCount++;
        }
        assertThat(errorCount).isEqualTo(3);

        // æµ‹è¯•è¿­ä»£è­¦å‘Šåˆ—è¡¨
        int warningCount = 0;
        for (String warning : result.getWarnings()) {
            assertThat(warning).isNotNull();
            warningCount++;
        }
        assertThat(warningCount).isEqualTo(2);
    }

    @Test
    @DisplayName("æµ‹è¯•ç‰¹æ®Šå­—ç¬¦å’ŒUnicodeå¤„ç†")
    void testSpecialCharactersAndUnicodeHandling() {
        List<String> errorsWithSpecialChars = Arrays.asList(
            "é”™è¯¯: ç‰ˆæœ¬å†²çª",
            "Error: ç‰ˆæœ¬å†²çª",
            "Plugin with Ã©mojis ğŸš€",
            "Unicode: Ã±Ã¡Ã©Ã­Ã³Ãº",
            "Special chars: !@#$%^&*()"
        );

        PluginCompatibilityResult result = PluginCompatibilityResult.incompatible(errorsWithSpecialChars);

        assertThat(result.isCompatible()).isFalse();
        assertThat(result.getErrors()).hasSize(5);
        assertThat(result.getErrors().get(0)).isEqualTo("é”™è¯¯: ç‰ˆæœ¬å†²çª");
        assertThat(result.getErrors().get(2)).isEqualTo("Plugin with Ã©mojis ğŸš€");
    }

    @Test
    @DisplayName("æµ‹è¯•å…¼å®¹æ€§ç»“æœçš„çº¿ç¨‹å®‰å…¨")
    void testCompatibilityResultThreadSafety() throws InterruptedException {
        PluginCompatibilityResult result = PluginCompatibilityResult.compatibleWithWarnings(Arrays.asList("warning"));

        int threadCount = 10;
        Thread[] threads = new Thread[threadCount];
        boolean[] readsSuccessful = new boolean[threadCount];

        for (int i = 0; i < threadCount; i++) {
            final int index = i;
            threads[i] = new Thread(() -> {
                try {
                    // å¤šæ¬¡è¯»å–ç»“æœï¼Œåº”è¯¥å§‹ç»ˆæˆåŠŸ
                    boolean compatible = result.isCompatible();
                    List<String> errors = result.getErrors();
                    List<String> warnings = result.getWarnings();
                    boolean hasErrors = result.hasErrors();
                    boolean hasWarnings = result.hasWarnings();
                    
                    readsSuccessful[index] = true;
                } catch (Exception e) {
                    readsSuccessful[index] = false;
                }
            });
            threads[i].start();
        }

        for (Thread thread : threads) {
            thread.join();
        }

        // éªŒè¯æ‰€æœ‰çº¿ç¨‹éƒ½èƒ½æˆåŠŸè¯»å–
        for (boolean success : readsSuccessful) {
            assertThat(success).isTrue();
        }
    }

    @Test
    @DisplayName("æµ‹è¯•å…¼å®¹æ€§ç»“æœçš„è¾¹ç•Œæ¡ä»¶")
    void testCompatibilityResultBoundaryConditions() {
        // æµ‹è¯•ç©ºå­—ç¬¦ä¸²é”™è¯¯å’Œè­¦å‘Š
        List<String> emptyStringErrors = Arrays.asList("");
        List<String> emptyStringWarnings = Arrays.asList("");

        PluginCompatibilityResult result1 = PluginCompatibilityResult.incompatibleWithWarnings(emptyStringErrors, emptyStringWarnings);
        assertThat(result1.isCompatible()).isFalse();
        assertThat(result1.getErrors()).containsExactly("");
        assertThat(result1.getWarnings()).containsExactly("");

        // æµ‹è¯•åªåŒ…å«ç©ºç™½å­—ç¬¦çš„æ¶ˆæ¯
        List<String> whitespaceMessages = Arrays.asList("   ", "\t\n");
        PluginCompatibilityResult result2 = PluginCompatibilityResult.incompatible(whitespaceMessages);
        assertThat(result2.isCompatible()).isFalse();
        assertThat(result2.getErrors()).hasSize(2);
    }

    @Test
    @DisplayName("æµ‹è¯•å…¼å®¹æ€§ç»“æœçš„å†…å­˜æ•ˆç‡")
    void testCompatibilityResultMemoryEfficiency() {
        // æµ‹è¯•å¤§é‡æ•°æ®æ—¶çš„å†…å­˜ä½¿ç”¨
        List<String> largeErrors = new ArrayList<>();
        for (int i = 0; i < 10000; i++) {
            largeErrors.add("Error message " + i);
        }

        PluginCompatibilityResult result = PluginCompatibilityResult.incompatible(largeErrors);

        // éªŒè¯å¼•ç”¨è€Œä¸æ˜¯å‰¯æœ¬ï¼ˆå¦‚æœå®ç°æ­£ç¡®ï¼‰
        assertThat(result.getErrors()).isEqualTo(largeErrors);

        // éªŒè¯é›†åˆæ˜¯ä¸å¯å˜çš„
        assertThatThrownBy(() -> result.getErrors().clear())
            .isInstanceOf(UnsupportedOperationException.class);
    }
}