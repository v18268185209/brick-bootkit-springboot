package com.zqzqq.bootkits.core.isolation;

import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

/**
 * 资源配额测试
 */
@DisplayName("ResourceQuota Test")
class ResourceQuotaTest {

    @Test
    @DisplayName("测试创建默认资源配额")
    void testCreateDefaultResourceQuota() {
        ResourceQuota quota = ResourceQuota.builder().build();
        
        assertThat(quota.getMaxMemoryBytes()).isEqualTo(256 * 1024 * 1024); // 256MB
        assertThat(quota.getMaxThreads()).isEqualTo(20);
        assertThat(quota.getMaxCpuPercent()).isEqualTo(50.0);
        assertThat(quota.getMaxNetworkConnections()).isEqualTo(100);
        assertThat(quota.getMaxFileDescriptors()).isEqualTo(1000);
        assertThat(quota.getMaxDiskIOBytesPerSecond()).isEqualTo(10 * 1024 * 1024); // 10MB/s
    }

    @Test
    @DisplayName("测试设置内存配额")
    void testSetMemoryQuota() {
        ResourceQuota quota = ResourceQuota.builder()
            .maxMemoryBytes(512 * 1024 * 1024) // 512MB
            .build();
        
        assertThat(quota.getMaxMemoryBytes()).isEqualTo(512 * 1024 * 1024);
    }

    @Test
    @DisplayName("测试设置线程配额")
    void testSetThreadQuota() {
        ResourceQuota quota = ResourceQuota.builder()
            .maxThreads(50)
            .build();
        
        assertThat(quota.getMaxThreads()).isEqualTo(50);
    }

    @Test
    @DisplayName("测试设置CPU配额")
    void testSetCpuQuota() {
        ResourceQuota quota = ResourceQuota.builder()
            .maxCpuPercent(80.0)
            .build();
        
        assertThat(quota.getMaxCpuPercent()).isEqualTo(80.0);
    }

    @Test
    @DisplayName("测试设置网络连接配额")
    void testSetNetworkQuota() {
        ResourceQuota quota = ResourceQuota.builder()
            .maxNetworkConnections(200)
            .build();
        
        assertThat(quota.getMaxNetworkConnections()).isEqualTo(200);
    }

    @Test
    @DisplayName("测试设置文件描述符配额")
    void testSetFileDescriptorQuota() {
        ResourceQuota quota = ResourceQuota.builder()
            .maxFileDescriptors(2000)
            .build();
        
        assertThat(quota.getMaxFileDescriptors()).isEqualTo(2000);
    }

    @Test
    @DisplayName("测试设置磁盘I/O配额")
    void testSetDiskIOQuota() {
        ResourceQuota quota = ResourceQuota.builder()
            .maxDiskIOBytesPerSecond(20 * 1024 * 1024) // 20MB/s
            .build();
        
        assertThat(quota.getMaxDiskIOBytesPerSecond()).isEqualTo(20 * 1024 * 1024);
    }

    @Test
    @DisplayName("测试设置所有配额")
    void testSetAllQuotas() {
        ResourceQuota quota = ResourceQuota.builder()
            .maxMemoryBytes(1024 * 1024 * 1024) // 1GB
            .maxThreads(100)
            .maxCpuPercent(90.0)
            .maxNetworkConnections(500)
            .maxFileDescriptors(5000)
            .maxDiskIOBytesPerSecond(50 * 1024 * 1024) // 50MB/s
            .build();
        
        assertThat(quota.getMaxMemoryBytes()).isEqualTo(1024 * 1024 * 1024);
        assertThat(quota.getMaxThreads()).isEqualTo(100);
        assertThat(quota.getMaxCpuPercent()).isEqualTo(90.0);
        assertThat(quota.getMaxNetworkConnections()).isEqualTo(500);
        assertThat(quota.getMaxFileDescriptors()).isEqualTo(5000);
        assertThat(quota.getMaxDiskIOBytesPerSecond()).isEqualTo(50 * 1024 * 1024);
    }

    @Test
    @DisplayName("测试无效的内存配额")
    void testInvalidMemoryQuota() {
        assertThatThrownBy(() -> ResourceQuota.builder()
            .maxMemoryBytes(-1)
            .build())
            .isInstanceOf(IllegalArgumentException.class);
    }

    @Test
    @DisplayName("测试无效的线程配额")
    void testInvalidThreadQuota() {
        assertThatThrownBy(() -> ResourceQuota.builder()
            .maxThreads(-5)
            .build())
            .isInstanceOf(IllegalArgumentException.class);
    }

    @Test
    @DisplayName("测试无效的CPU配额")
    void testInvalidCpuQuota() {
        // CPU百分比不能为负数
        assertThatThrownBy(() -> ResourceQuota.builder()
            .maxCpuPercent(-10.0)
            .build())
            .isInstanceOf(IllegalArgumentException.class);

        // CPU百分比不能超过100
        assertThatThrownBy(() -> ResourceQuota.builder()
            .maxCpuPercent(150.0)
            .build())
            .isInstanceOf(IllegalArgumentException.class);
    }

    @Test
    @DisplayName("测试无效的网络连接配额")
    void testInvalidNetworkQuota() {
        assertThatThrownBy(() -> ResourceQuota.builder()
            .maxNetworkConnections(-1)
            .build())
            .isInstanceOf(IllegalArgumentException.class);
    }

    @Test
    @DisplayName("测试无效的文件描述符配额")
    void testInvalidFileDescriptorQuota() {
        assertThatThrownBy(() -> ResourceQuota.builder()
            .maxFileDescriptors(-1)
            .build())
            .isInstanceOf(IllegalArgumentException.class);
    }

    @Test
    @DisplayName("测试无效的磁盘I/O配额")
    void testInvalidDiskIOQuota() {
        assertThatThrownBy(() -> ResourceQuota.builder()
            .maxDiskIOBytesPerSecond(-1)
            .build())
            .isInstanceOf(IllegalArgumentException.class);
    }

    @Test
    @DisplayName("测试无限制配额")
    void testUnlimitedQuota() {
        ResourceQuota quota = ResourceQuota.builder()
            .maxMemoryBytes(0)
            .maxThreads(0)
            .maxCpuPercent(0.0)
            .maxNetworkConnections(0)
            .maxFileDescriptors(0)
            .maxDiskIOBytesPerSecond(0)
            .build();
        
        // 0值表示无限制
        assertThat(quota.getMaxMemoryBytes()).isEqualTo(0);
        assertThat(quota.getMaxThreads()).isEqualTo(0);
        assertThat(quota.getMaxCpuPercent()).isEqualTo(0.0);
        assertThat(quota.getMaxNetworkConnections()).isEqualTo(0);
        assertThat(quota.getMaxFileDescriptors()).isEqualTo(0);
        assertThat(quota.getMaxDiskIOBytesPerSecond()).isEqualTo(0);
    }

    @Test
    @DisplayName("测试边界值配额")
    void testBoundaryValueQuotas() {
        // 测试最大允许值
        ResourceQuota quota = ResourceQuota.builder()
            .maxMemoryBytes(Long.MAX_VALUE)
            .maxThreads(Integer.MAX_VALUE)
            .maxCpuPercent(100.0)
            .maxNetworkConnections(Integer.MAX_VALUE)
            .maxFileDescriptors(Integer.MAX_VALUE)
            .maxDiskIOBytesPerSecond(Long.MAX_VALUE)
            .build();
        
        assertThat(quota.getMaxMemoryBytes()).isEqualTo(Long.MAX_VALUE);
        assertThat(quota.getMaxThreads()).isEqualTo(Integer.MAX_VALUE);
        assertThat(quota.getMaxCpuPercent()).isEqualTo(100.0);
        assertThat(quota.getMaxNetworkConnections()).isEqualTo(Integer.MAX_VALUE);
        assertThat(quota.getMaxFileDescriptors()).isEqualTo(Integer.MAX_VALUE);
        assertThat(quota.getMaxDiskIOBytesPerSecond()).isEqualTo(Long.MAX_VALUE);
    }

    @Test
    @DisplayName("测试配额对象的不可变性")
    void testQuotaImmutability() {
        ResourceQuota quota = ResourceQuota.builder()
            .maxMemoryBytes(512 * 1024 * 1024)
            .maxThreads(50)
            .build();
        
        // 一旦创建，配额对象不应该被修改
        // 由于ResourceQuota可能是不可变的，这应该成立
        // 验证对象的方法调用不抛出异常
        assertThat(quota.getMaxMemoryBytes()).isEqualTo(512 * 1024 * 1024);
        assertThat(quota.getMaxThreads()).isEqualTo(50);
        assertThat(quota.getMaxCpuPercent()).isEqualTo(50.0); // 默认值
    }

    @Test
    @DisplayName("测试配额对象的equals和hashCode")
    void testQuotaEqualsAndHashCode() {
        ResourceQuota quota1 = ResourceQuota.builder()
            .maxMemoryBytes(512 * 1024 * 1024)
            .maxThreads(50)
            .build();
            
        ResourceQuota quota2 = ResourceQuota.builder()
            .maxMemoryBytes(512 * 1024 * 1024)
            .maxThreads(50)
            .build();
            
        ResourceQuota quota3 = ResourceQuota.builder()
            .maxMemoryBytes(1024 * 1024 * 1024)
            .maxThreads(50)
            .build();
        
        assertThat(quota1).isEqualTo(quota2);
        assertThat(quota1.hashCode()).isEqualTo(quota2.hashCode());
        assertThat(quota1).isNotEqualTo(quota3);
        assertThat(quota1.hashCode()).isNotEqualTo(quota3.hashCode());
    }

    @Test
    @DisplayName("测试配额对象的toString")
    void testQuotaToString() {
        ResourceQuota quota = ResourceQuota.builder()
            .maxMemoryBytes(512 * 1024 * 1024)
            .maxThreads(50)
            .maxCpuPercent(80.0)
            .build();
        
        String str = quota.toString();
        assertThat(str).contains("ResourceQuota");
        assertThat(str).contains("maxMemoryBytes=536870912"); // 512MB in bytes
        assertThat(str).contains("maxThreads=50");
        assertThat(str).contains("maxCpuPercent=80.0");
    }

    @Test
    @DisplayName("测试复杂配额场景")
    void testComplexQuotaScenarios() {
        // 高性能应用配额
        ResourceQuota highPerformanceQuota = ResourceQuota.builder()
            .maxMemoryBytes(2048 * 1024 * 1024) // 2GB
            .maxThreads(200)
            .maxCpuPercent(95.0)
            .maxNetworkConnections(1000)
            .maxFileDescriptors(10000)
            .maxDiskIOBytesPerSecond(100 * 1024 * 1024) // 100MB/s
            .build();
        
        assertThat(highPerformanceQuota.getMaxMemoryBytes()).isEqualTo(2048L * 1024 * 1024);
        assertThat(highPerformanceQuota.getMaxThreads()).isEqualTo(200);
        assertThat(highPerformanceQuota.getMaxCpuPercent()).isEqualTo(95.0);
        assertThat(highPerformanceQuota.getMaxNetworkConnections()).isEqualTo(1000);
        assertThat(highPerformanceQuota.getMaxFileDescriptors()).isEqualTo(10000);
        assertThat(highPerformanceQuota.getMaxDiskIOBytesPerSecond()).isEqualTo(100L * 1024 * 1024);

        // 轻量级应用配额
        ResourceQuota lightweightQuota = ResourceQuota.builder()
            .maxMemoryBytes(64 * 1024 * 1024) // 64MB
            .maxThreads(5)
            .maxCpuPercent(20.0)
            .maxNetworkConnections(10)
            .maxFileDescriptors(100)
            .maxDiskIOBytesPerSecond(1024 * 1024) // 1MB/s
            .build();
        
        assertThat(lightweightQuota.getMaxMemoryBytes()).isEqualTo(64L * 1024 * 1024);
        assertThat(lightweightQuota.getMaxThreads()).isEqualTo(5);
        assertThat(lightweightQuota.getMaxCpuPercent()).isEqualTo(20.0);
        assertThat(lightweightQuota.getMaxNetworkConnections()).isEqualTo(10);
        assertThat(lightweightQuota.getMaxFileDescriptors()).isEqualTo(100);
        assertThat(lightweightQuota.getMaxDiskIOBytesPerSecond()).isEqualTo(1024L * 1024);
    }

    @Test
    @DisplayName("测试配额构建器的链式调用")
    void testQuotaBuilderMethodChaining() {
        ResourceQuota quota = ResourceQuota.builder()
            .maxMemoryBytes(512 * 1024 * 1024)
            .maxThreads(50)
            .maxCpuPercent(80.0)
            .maxNetworkConnections(200)
            .maxFileDescriptors(1000)
            .maxDiskIOBytesPerSecond(20 * 1024 * 1024)
            .build();
        
        assertThat(quota).isNotNull();
        assertThat(quota.getMaxMemoryBytes()).isEqualTo(512L * 1024 * 1024);
        assertThat(quota.getMaxThreads()).isEqualTo(50);
        assertThat(quota.getMaxCpuPercent()).isEqualTo(80.0);
        assertThat(quota.getMaxNetworkConnections()).isEqualTo(200);
        assertThat(quota.getMaxFileDescriptors()).isEqualTo(1000);
        assertThat(quota.getMaxDiskIOBytesPerSecond()).isEqualTo(20L * 1024 * 1024);
    }

    @Test
    @DisplayName("测试配额验证逻辑")
    void testQuotaValidationLogic() {
        // 测试各种边界情况
        assertThatThrownBy(() -> ResourceQuota.builder().maxMemoryBytes(-1).build())
            .isInstanceOf(IllegalArgumentException.class);
            
        assertThatThrownBy(() -> ResourceQuota.builder().maxThreads(-1).build())
            .isInstanceOf(IllegalArgumentException.class);
            
        assertThatThrownBy(() -> ResourceQuota.builder().maxCpuPercent(-1).build())
            .isInstanceOf(IllegalArgumentException.class);
            
        assertThatThrownBy(() -> ResourceQuota.builder().maxCpuPercent(101).build())
            .isInstanceOf(IllegalArgumentException.class);
            
        assertThatThrownBy(() -> ResourceQuota.builder().maxNetworkConnections(-1).build())
            .isInstanceOf(IllegalArgumentException.class);
            
        assertThatThrownBy(() -> ResourceQuota.builder().maxFileDescriptors(-1).build())
            .isInstanceOf(IllegalArgumentException.class);
            
        assertThatThrownBy(() -> ResourceQuota.builder().maxDiskIOBytesPerSecond(-1).build())
            .isInstanceOf(IllegalArgumentException.class);
    }

    @Test
    @DisplayName("测试配额对象的内存效率")
    void testQuotaMemoryEfficiency() {
        // 创建大量配额对象以测试内存使用
        int count = 10000;
        ResourceQuota[] quotas = new ResourceQuota[count];
        
        for (int i = 0; i < count; i++) {
            quotas[i] = ResourceQuota.builder()
                .maxMemoryBytes(i * 1024 * 1024)
                .maxThreads(i % 100 + 1)
                .build();
        }
        
        // 验证所有对象都正确创建
        assertThat(quotas[0].getMaxMemoryBytes()).isEqualTo(0);
        assertThat(quotas[count - 1].getMaxMemoryBytes()).isEqualTo((count - 1) * 1024L * 1024);
        assertThat(quotas[0].getMaxThreads()).isEqualTo(1);
        assertThat(quotas[count - 1].getMaxThreads()).isEqualTo(count % 100 + 1);
    }
}