package com.zqzqq.bootkits.core.dependency;

import com.zqzqq.bootkits.core.version.VersionUtils;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

/**
 * 插件依赖测试
 */
@DisplayName("PluginDependency Test")
class PluginDependencyTest {

    @Test
    @DisplayName("测试创建基本插件依赖")
    void testBasicPluginDependency() {
        PluginDependency dependency = PluginDependency.newBuilder("test-plugin", "1.0.0")
            .build();

        assertThat(dependency.getPluginId()).isEqualTo("test-plugin");
        assertThat(dependency.getType()).isEqualTo(PluginDependencyType.REQUIRED);
        assertThat(dependency.getVersionConstraints()).isEmpty();
        assertThat(dependency.getMetadata()).isEmpty();
        assertThat(dependency.getOptional()).isFalse();
        assertThat(dependency.getTransitive()).isFalse();
        assertThat(dependency.getScope()).isEqualTo("compile");
    }

    @Test
    @DisplayName("测试构建器参数验证")
    void testBuilderParameterValidation() {
        // 测试null插件ID
        assertThatThrownBy(() -> PluginDependency.newBuilder(null, "1.0.0"))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessage("插件ID不能为空");

        // 测试空插件ID
        assertThatThrownBy(() -> PluginDependency.newBuilder("", "1.0.0"))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessage("插件ID不能为空");
    }

    @Test
    @DisplayName("测试设置依赖类型")
    void testSetDependencyType() {
        PluginDependency requiredDep = PluginDependency.newBuilder("plugin-a", "1.0.0")
            .setType(PluginDependencyType.REQUIRED)
            .build();

        PluginDependency optionalDep = PluginDependency.newBuilder("plugin-b", "1.0.0")
            .setType(PluginDependencyType.OPTIONAL)
            .build();

        PluginDependency providedDep = PluginDependency.newBuilder("plugin-c", "1.0.0")
            .setType(PluginDependencyType.PROVIDED)
            .build();

        assertThat(requiredDep.getType()).isEqualTo(PluginDependencyType.REQUIRED);
        assertThat(optionalDep.getType()).isEqualTo(PluginDependencyType.OPTIONAL);
        assertThat(providedDep.getType()).isEqualTo(PluginDependencyType.PROVIDED);
    }

    @Test
    @DisplayName("测试添加版本约束")
    void testAddVersionConstraints() {
        VersionConstraint constraint1 = VersionConstraint.parse(">=1.0.0");
        VersionConstraint constraint2 = VersionConstraint.parse("<2.0.0");

        PluginDependency dependency = PluginDependency.newBuilder("test-plugin", "1.0.0")
            .addVersionConstraint("constraint1", constraint1)
            .addVersionConstraint("constraint2", constraint2)
            .build();

        Map<String, VersionConstraint> constraints = dependency.getVersionConstraints();
        assertThat(constraints).hasSize(2);
        assertThat(constraints).containsKey("constraint1");
        assertThat(constraints).containsKey("constraint2");
        assertThat(constraints.get("constraint1")).isEqualTo(constraint1);
        assertThat(constraints.get("constraint2")).isEqualTo(constraint2);
    }

    @Test
    @DisplayName("测试添加元数据")
    void testAddMetadata() {
        PluginDependency dependency = PluginDependency.newBuilder("test-plugin", "1.0.0")
            .addMetadata("author", "Test Author")
            .addMetadata("version", "1.0.0")
            .addMetadata("category", "utility")
            .build();

        Map<String, String> metadata = dependency.getMetadata();
        assertThat(metadata).hasSize(3);
        assertThat(metadata.get("author")).isEqualTo("Test Author");
        assertThat(metadata.get("version")).isEqualTo("1.0.0");
        assertThat(metadata.get("category")).isEqualTo("utility");
    }

    @Test
    @DisplayName("测试设置可选和传递依赖")
    void testSetOptionalAndTransitive() {
        PluginDependency dependency = PluginDependency.newBuilder("test-plugin", "1.0.0")
            .setOptional(true)
            .setTransitive(true)
            .build();

        assertThat(dependency.getOptional()).isTrue();
        assertThat(dependency.getTransitive()).isTrue();
    }

    @Test
    @DisplayName("测试设置作用域")
    void testSetScope() {
        PluginDependency runtimeDep = PluginDependency.newBuilder("plugin-a", "1.0.0")
            .setScope("runtime")
            .build();

        PluginDependency testDep = PluginDependency.newBuilder("plugin-b", "1.0.0")
            .setScope("test")
            .build();

        assertThat(runtimeDep.getScope()).isEqualTo("runtime");
        assertThat(testDep.getScope()).isEqualTo("test");
    }

    @Test
    @DisplayName("测试设置版本约束")
    void testSetVersionConstraints() {
        Map<String, VersionConstraint> constraints = new HashMap<>();
        constraints.put("min-version", VersionConstraint.parse(">=1.0.0"));
        constraints.put("max-version", VersionConstraint.parse("<3.0.0"));

        PluginDependency dependency = PluginDependency.newBuilder("test-plugin", "1.0.0")
            .setVersionConstraints(constraints)
            .build();

        assertThat(dependency.getVersionConstraints()).isEqualTo(constraints);
    }

    @Test
    @DisplayName("测试设置依赖解释")
    void testSetDependencyExplanation() {
        String explanation = "This plugin provides essential database functionality";

        PluginDependency dependency = PluginDependency.newBuilder("test-plugin", "1.0.0")
            .setDependencyExplanation(explanation)
            .build();

        assertThat(dependency.getDependencyExplanation()).isEqualTo(explanation);
    }

    @Test
    @DisplayName("测试toString方法")
    void testToString() {
        PluginDependency dependency = PluginDependency.newBuilder("test-plugin", "1.0.0")
            .setType(PluginDependencyType.REQUIRED)
            .addMetadata("author", "Test Author")
            .build();

        String str = dependency.toString();
        assertThat(str).contains("test-plugin");
        assertThat(str).contains("REQUIRED");
    }

    @Test
    @DisplayName("测试构建器方法链式调用")
    void testBuilderMethodChaining() {
        PluginDependency dependency = PluginDependency.newBuilder("test-plugin", "1.0.0")
            .setType(PluginDependencyType.OPTIONAL)
            .setOptional(true)
            .setTransitive(false)
            .setScope("runtime")
            .addMetadata("key1", "value1")
            .addMetadata("key2", "value2")
            .setDependencyExplanation("Test explanation")
            .build();

        assertThat(dependency).isNotNull();
        assertThat(dependency.getPluginId()).isEqualTo("test-plugin");
        assertThat(dependency.getType()).isEqualTo(PluginDependencyType.OPTIONAL);
        assertThat(dependency.getOptional()).isTrue();
        assertThat(dependency.getTransitive()).isFalse();
        assertThat(dependency.getScope()).isEqualTo("runtime");
        assertThat(dependency.getMetadata()).hasSize(2);
        assertThat(dependency.getDependencyExplanation()).isEqualTo("Test explanation");
    }

    @Test
    @DisplayName("测试不可变集合")
    void testUnmodifiableCollections() {
        PluginDependency dependency = PluginDependency.newBuilder("test-plugin", "1.0.0")
            .addMetadata("key", "value")
            .addVersionConstraint("constraint", VersionConstraint.parse(">=1.0.0"))
            .build();

        // 验证返回的集合是不可变的
        assertThatThrownBy(() -> dependency.getMetadata().put("new-key", "value"))
            .isInstanceOf(UnsupportedOperationException.class);

        assertThatThrownBy(() -> dependency.getVersionConstraints().put("new-constraint", VersionConstraint.parse(">=2.0.0")))
            .isInstanceOf(UnsupportedOperationException.class);
    }

    @Test
    @DisplayName("测试复杂依赖配置")
    void testComplexDependencyConfiguration() {
        Map<String, VersionConstraint> constraints = new HashMap<>();
        constraints.put("core", VersionConstraint.parse(">=2.0.0"));
        constraints.put("database", VersionConstraint.parse(">=1.5.0 <3.0.0"));

        Map<String, String> metadata = new HashMap<>();
        metadata.put("author", "Test Team");
        metadata.put("category", "backend");
        metadata.put("tags", "database,sql");

        PluginDependency dependency = PluginDependency.newBuilder("complex-plugin", "1.0.0")
            .setType(PluginDependencyType.REQUIRED)
            .setOptional(false)
            .setTransitive(true)
            .setScope("compile")
            .setVersionConstraints(constraints)
            .setDependencyExplanation("Complex database plugin with multiple dependencies")
            .addMetadata("version", "1.0.0")
            .addMetadata("license", "MIT")
            .build();

        assertThat(dependency.getPluginId()).isEqualTo("complex-plugin");
        assertThat(dependency.getType()).isEqualTo(PluginDependencyType.REQUIRED);
        assertThat(dependency.getOptional()).isFalse();
        assertThat(dependency.getTransitive()).isTrue();
        assertThat(dependency.getScope()).isEqualTo("compile");
        assertThat(dependency.getVersionConstraints()).isEqualTo(constraints);
        assertThat(dependency.getDependencyExplanation()).isEqualTo("Complex database plugin with multiple dependencies");
        assertThat(dependency.getMetadata()).hasSize(5); // includes 2 added metadata + 3 from map
    }

    @Test
    @DisplayName("测试空操作的处理")
    void testEmptyOperationsHandling() {
        // 测试添加null值
        PluginDependency dependency = PluginDependency.newBuilder("test-plugin", "1.0.0")
            .addMetadata(null, "value")
            .addMetadata("key", null)
            .addVersionConstraint(null, null)
            .setDependencyExplanation(null)
            .build();

        assertThat(dependency).isNotNull();
        assertThat(dependency.getMetadata()).isEmpty();
        assertThat(dependency.getVersionConstraints()).isEmpty();
        assertThat(dependency.getDependencyExplanation()).isNull();
    }

    @Test
    @DisplayName("测试默认值的正确性")
    void testDefaultValuesCorrectness() {
        PluginDependency dependency = PluginDependency.newBuilder("test-plugin", "1.0.0").build();

        assertThat(dependency.getType()).isEqualTo(PluginDependencyType.REQUIRED);
        assertThat(dependency.getOptional()).isFalse();
        assertThat(dependency.getTransitive()).isFalse();
        assertThat(dependency.getScope()).isEqualTo("compile");
        assertThat(dependency.getVersionConstraints()).isEmpty();
        assertThat(dependency.getMetadata()).isEmpty();
        assertThat(dependency.getDependencyExplanation()).isNull();
    }

    @Test
    @DisplayName("测试构建器状态独立性")
    void testBuilderStateIndependence() {
        // 第一个构建器
        PluginDependency.Builder builder1 = PluginDependency.newBuilder("plugin-1", "1.0.0")
            .setType(PluginDependencyType.OPTIONAL)
            .addMetadata("key1", "value1");

        // 第二个构建器（独立）
        PluginDependency.Builder builder2 = PluginDependency.newBuilder("plugin-2", "1.0.0")
            .setType(PluginDependencyType.REQUIRED)
            .addMetadata("key2", "value2");

        PluginDependency dep1 = builder1.build();
        PluginDependency dep2 = builder2.build();

        assertThat(dep1.getPluginId()).isEqualTo("plugin-1");
        assertThat(dep1.getType()).isEqualTo(PluginDependencyType.OPTIONAL);
        assertThat(dep1.getMetadata().get("key1")).isEqualTo("value1");

        assertThat(dep2.getPluginId()).isEqualTo("plugin-2");
        assertThat(dep2.getType()).isEqualTo(PluginDependencyType.REQUIRED);
        assertThat(dep2.getMetadata().get("key2")).isEqualTo("value2");

        // 验证相互独立
        assertThat(dep1.getMetadata()).doesNotContainKey("key2");
        assertThat(dep2.getMetadata()).doesNotContainKey("key1");
    }
}