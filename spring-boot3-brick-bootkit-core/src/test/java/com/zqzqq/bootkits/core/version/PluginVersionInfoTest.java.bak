package com.zqzqq.bootkits.core.version;

import com.zqzqq.bootkits.core.dependency.VersionConstraint;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

/**
 * 插件版本信息测试
 */
@DisplayName("PluginVersionInfo Test")
class PluginVersionInfoTest {

    private PluginVersionInfo.Builder builder1;
    private PluginVersionInfo.Builder builder2;

    @BeforeEach
    void setUp() {
        builder1 = PluginVersionInfo.newBuilder("test-plugin", "1.2.3");
        builder2 = PluginVersionInfo.newBuilder("dependency-plugin", "2.0.0");
    }

    @Test
    @DisplayName("测试创建基本插件版本信息")
    void testBasicPluginVersionInfo() {
        PluginVersionInfo info = builder1.build();
        
        assertThat(info.getPluginId()).isEqualTo("test-plugin");
        assertThat(info.getVersion().getMajor()).isEqualTo(1);
        assertThat(info.getVersion().getMinor()).isEqualTo(2);
        assertThat(info.getVersion().getPatch()).isEqualTo(3);
        assertThat(info.getRequiredPlugins()).isEmpty();
        assertThat(info.getOptionalPlugins()).isEmpty();
        assertThat(info.getVersionConstraints()).isEmpty();
        assertThat(info.getMetadata()).isEmpty();
        assertThat(info.getConflicts()).isEmpty();
        assertThat(info.isDeprecated()).isFalse();
        assertThat(info.getDeprecationMessage()).isNull();
    }

    @Test
    @DisplayName("测试创建器参数验证")
    void testBuilderParameterValidation() {
        // 测试null插件ID
        assertThatThrownBy(() -> PluginVersionInfo.newBuilder(null, "1.0.0"))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessage("插件ID不能为空");

        // 测试空插件ID
        assertThatThrownBy(() -> PluginVersionInfo.newBuilder("", "1.0.0"))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessage("插件ID不能为空");

        // 测试null版本
        assertThatThrownBy(() -> PluginVersionInfo.newBuilder("test-plugin", null))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessage("插件版本不能为空");

        // 测试空版本
        assertThatThrownBy(() -> PluginVersionInfo.newBuilder("test-plugin", ""))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessage("插件版本不能为空");
    }

    @Test
    @DisplayName("测试添加必需依赖")
    void testAddRequiredPlugins() {
        PluginVersionInfo info = builder1
            .addRequiredPlugin("dependency1")
            .addRequiredPlugin("dependency2")
            .addRequiredPlugin("dependency1") // 重复添加
            .build();

        List<String> required = info.getRequiredPlugins();
        assertThat(required).hasSize(2);
        assertThat(required).containsExactlyInAnyOrder("dependency1", "dependency2");
    }

    @Test
    @DisplayName("测试添加可选依赖")
    void testAddOptionalPlugins() {
        PluginVersionInfo info = builder1
            .addOptionalPlugin("optional1")
            .addOptionalPlugin("optional2")
            .addOptionalPlugin("optional1") // 重复添加
            .build();

        List<String> optional = info.getOptionalPlugins();
        assertThat(optional).hasSize(2);
        assertThat(optional).containsExactlyInAnyOrder("optional1", "optional2");
    }

    @Test
    @DisplayName("测试添加版本约束")
    void testAddVersionConstraints() {
        VersionConstraint constraint1 = VersionConstraint.parse(">=1.0.0");
        VersionConstraint constraint2 = VersionConstraint.parse("<2.0.0");
        
        PluginVersionInfo info = builder1
            .addVersionConstraint("dep1", constraint1)
            .addVersionConstraint("dep2", constraint2)
            .build();

        Map<String, VersionConstraint> constraints = info.getVersionConstraints();
        assertThat(constraints).hasSize(2);
        assertThat(constraints).containsKey("dep1");
        assertThat(constraints).containsKey("dep2");
        assertThat(constraints.get("dep1")).isEqualTo(constraint1);
        assertThat(constraints.get("dep2")).isEqualTo(constraint2);
    }

    @Test
    @DisplayName("测试添加元数据")
    void testAddMetadata() {
        PluginVersionInfo info = builder1
            .addMetadata("author", "Test Author")
            .addMetadata("description", "Test Description")
            .addMetadata("license", "MIT")
            .addMetadata("author", "Updated Author") // 更新现有键
            .build();

        Map<String, String> metadata = info.getMetadata();
        assertThat(metadata).hasSize(3);
        assertThat(metadata.get("author")).isEqualTo("Updated Author");
        assertThat(metadata.get("description")).isEqualTo("Test Description");
        assertThat(metadata.get("license")).isEqualTo("MIT");
    }

    @Test
    @DisplayName("测试设置框架版本范围")
    void testFrameworkVersionSettings() {
        PluginVersionInfo info = builder1
            .setMinimumFrameworkVersion("3.0.0")
            .setMaximumFrameworkVersion("4.0.0")
            .setTargetFrameworkVersion("3.5.0")
            .build();

        assertThat(info.getMinimumFrameworkVersion()).isEqualTo("3.0.0");
        assertThat(info.getMaximumFrameworkVersion()).isEqualTo("4.0.0");
        assertThat(info.getTargetFrameworkVersion()).isEqualTo("3.5.0");
    }

    @Test
    @DisplayName("测试添加冲突插件")
    void testAddConflicts() {
        PluginVersionInfo info = builder1
            .addConflict("conflicting-plugin-1")
            .addConflict("conflicting-plugin-2")
            .addConflict("conflicting-plugin-1") // 重复添加
            .build();

        List<String> conflicts = info.getConflicts();
        assertThat(conflicts).hasSize(2);
        assertThat(conflicts).containsExactlyInAnyOrder("conflicting-plugin-1", "conflicting-plugin-2");
    }

    @Test
    @DisplayName("测试弃用标记")
    void testDeprecationMarking() {
        // 不弃用的插件
        PluginVersionInfo info1 = builder1.build();
        assertThat(info1.isDeprecated()).isFalse();
        assertThat(info1.getDeprecationMessage()).isNull();

        // 弃用的插件
        String deprecationMessage = "This plugin is deprecated, please use v2.0.0";
        PluginVersionInfo info2 = builder1
            .setDeprecated(deprecationMessage)
            .build();

        assertThat(info2.isDeprecated()).isTrue();
        assertThat(info2.getDeprecationMessage()).isEqualTo(deprecationMessage);
    }

    @Test
    @DisplayName("测试toString方法")
    void testToString() {
        PluginVersionInfo info = builder1
            .addRequiredPlugin("dep1")
            .addOptionalPlugin("opt1")
            .addConflict("conflict1")
            .build();

        String str = info.toString();
        assertThat(str).contains("PluginVersionInfo{pluginId='test-plugin'");
        assertThat(str).contains("version='1.2.3'");
        assertThat(str).contains("requiredPlugins=[dep1]");
        assertThat(str).contains("optionalPlugins=[opt1]");
        assertThat(str).contains("conflicts=[conflict1]");
    }

    @Test
    @DisplayName("测试版本兼容性验证 - 基本情况")
    void testVersionCompatibilityValidationBasic() {
        PluginVersionInfo info1 = PluginVersionInfo.newBuilder("plugin-a", "1.0.0").build();
        PluginVersionInfo info2 = PluginVersionInfo.newBuilder("plugin-b", "1.0.0").build();

        PluginVersionInfo.VersionCompatibilityResult result = info1.validateCompatibility(info2);
        
        assertThat(result.isCompatible()).isTrue();
        assertThat(result.getIssues()).isEmpty();
        assertThat(result.getWarnings()).isEmpty();
    }

    @Test
    @DisplayName("测试版本兼容性验证 - 框架版本冲突")
    void testVersionCompatibilityFrameworkConflict() {
        PluginVersionInfo info1 = PluginVersionInfo.newBuilder("plugin-a", "1.0.0")
            .setMinimumFrameworkVersion("4.0.0")
            .setMaximumFrameworkVersion("5.0.0")
            .build();
            
        PluginVersionInfo info2 = PluginVersionInfo.newBuilder("plugin-b", "1.0.0")
            .setTargetFrameworkVersion("3.5.0")
            .build();

        PluginVersionInfo.VersionCompatibilityResult result = info1.validateCompatibility(info2);
        
        assertThat(result.isCompatible()).isFalse();
        assertThat(result.getIssues()).hasSize(1);
        assertThat(result.getIssues().get(0)).contains("框架版本要求冲突");
    }

    @Test
    @DisplayName("测试版本兼容性验证 - 依赖冲突")
    void testVersionCompatibilityDependencyConflict() {
        PluginVersionInfo info1 = PluginVersionInfo.newBuilder("plugin-a", "1.0.0")
            .addRequiredPlugin("plugin-b")
            .addVersionConstraint("plugin-b", VersionConstraint.parse(">=2.0.0"))
            .build();
            
        PluginVersionInfo info2 = PluginVersionInfo.newBuilder("plugin-b", "1.0.0").build();

        PluginVersionInfo.VersionCompatibilityResult result = info1.validateCompatibility(info2);
        
        assertThat(result.isCompatible()).isFalse();
        assertThat(result.getIssues()).hasSize(1);
        assertThat(result.getIssues().get(0)).contains("版本约束不满足");
    }

    @Test
    @DisplayName("测试版本兼容性验证 - 插件冲突")
    void testVersionCompatibilityPluginConflict() {
        PluginVersionInfo info1 = PluginVersionInfo.newBuilder("plugin-a", "1.0.0")
            .addConflict("plugin-b")
            .build();
            
        PluginVersionInfo info2 = PluginVersionInfo.newBuilder("plugin-b", "1.0.0").build();

        PluginVersionInfo.VersionCompatibilityResult result = info1.validateCompatibility(info2);
        
        assertThat(result.isCompatible()).isFalse();
        assertThat(result.getIssues()).hasSize(1);
        assertThat(result.getIssues().get(0)).contains("插件冲突");
    }

    @Test
    @DisplayName("测试版本兼容性验证 - 弃用警告")
    void testVersionCompatibilityDeprecationWarning() {
        PluginVersionInfo info1 = PluginVersionInfo.newBuilder("plugin-a", "1.0.0").build();
        PluginVersionInfo info2 = PluginVersionInfo.newBuilder("plugin-b", "1.0.0")
            .setDeprecated("This plugin is deprecated")
            .build();

        PluginVersionInfo.VersionCompatibilityResult result = info1.validateCompatibility(info2);
        
        assertThat(result.isCompatible()).isTrue();
        assertThat(result.hasWarnings()).isTrue();
        assertThat(result.getWarnings()).hasSize(1);
        assertThat(result.getWarnings().get(0)).contains("依赖插件已弃用");
    }

    @Test
    @DisplayName("测试不可变集合")
    void testUnmodifiableCollections() {
        PluginVersionInfo info = builder1
            .addRequiredPlugin("dep1")
            .addOptionalPlugin("opt1")
            .addMetadata("key", "value")
            .addVersionConstraint("dep1", VersionConstraint.parse(">=1.0.0"))
            .addConflict("conflict1")
            .build();

        // 验证返回的集合是不可变的
        assertThatThrownBy(() -> info.getRequiredPlugins().add("new-dep"))
            .isInstanceOf(UnsupportedOperationException.class);

        assertThatThrownBy(() -> info.getOptionalPlugins().add("new-opt"))
            .isInstanceOf(UnsupportedOperationException.class);

        assertThatThrownBy(() -> info.getMetadata().put("new-key", "value"))
            .isInstanceOf(UnsupportedOperationException.class);

        assertThatThrownBy(() -> info.getVersionConstraints().put("new-dep", VersionConstraint.parse(">=1.0.0")))
            .isInstanceOf(UnsupportedOperationException.class);

        assertThatThrownBy(() -> info.getConflicts().add("new-conflict"))
            .isInstanceOf(UnsupportedOperationException.class);
    }

    @Test
    @DisplayName("测试复杂插件版本信息")
    void testComplexPluginVersionInfo() {
        PluginVersionInfo info = builder1
            .addRequiredPlugin("core-plugin")
            .addRequiredPlugin("database-plugin")
            .addOptionalPlugin("logging-plugin")
            .addOptionalPlugin("monitoring-plugin")
            .addVersionConstraint("core-plugin", VersionConstraint.parse(">=2.0.0"))
            .addVersionConstraint("database-plugin", VersionConstraint.parse(">=1.5.0 <3.0.0"))
            .addMetadata("author", "Test Team")
            .addMetadata("category", "utility")
            .addMetadata("tags", "backend,data")
            .setMinimumFrameworkVersion("3.5.0")
            .setMaximumFrameworkVersion("4.0.0")
            .setTargetFrameworkVersion("3.8.0")
            .addConflict("legacy-plugin")
            .setDeprecated("Use plugin-b v2.0.0 instead")
            .build();

        // 验证所有字段
        assertThat(info.getPluginId()).isEqualTo("test-plugin");
        assertThat(info.getVersion().toString()).isEqualTo("1.2.3");
        assertThat(info.getRequiredPlugins()).hasSize(2);
        assertThat(info.getOptionalPlugins()).hasSize(2);
        assertThat(info.getVersionConstraints()).hasSize(2);
        assertThat(info.getMetadata()).hasSize(3);
        assertThat(info.getMinimumFrameworkVersion()).isEqualTo("3.5.0");
        assertThat(info.getMaximumFrameworkVersion()).isEqualTo("4.0.0");
        assertThat(info.getTargetFrameworkVersion()).isEqualTo("3.8.0");
        assertThat(info.getConflicts()).hasSize(1);
        assertThat(info.isDeprecated()).isTrue();
        assertThat(info.getDeprecationMessage()).isEqualTo("Use plugin-b v2.0.0 instead");
    }

    @Test
    @DisplayName("测试版本兼容性结果")
    void testVersionCompatibilityResult() {
        List<String> issues = Arrays.asList("Issue 1", "Issue 2");
        List<String> warnings = Arrays.asList("Warning 1", "Warning 2");

        PluginVersionInfo.VersionCompatibilityResult result = 
            new PluginVersionInfo.VersionCompatibilityResult(issues, warnings);

        assertThat(result.getIssues()).isEqualTo(issues);
        assertThat(result.getWarnings()).isEqualTo(warnings);
        assertThat(result.isCompatible()).isFalse();
        assertThat(result.hasWarnings()).isTrue();

        // 测试空结果
        PluginVersionInfo.VersionCompatibilityResult emptyResult = 
            new PluginVersionInfo.VersionCompatibilityResult(Arrays.asList(), Arrays.asList());
        assertThat(emptyResult.isCompatible()).isTrue();
        assertThat(emptyResult.hasWarnings()).isFalse();
    }

    @Test
    @DisplayName("测试toString方法包含所有信息")
    void testToStringContainsAllInfo() {
        PluginVersionInfo info = builder1
            .addRequiredPlugin("dep1")
            .addOptionalPlugin("opt1")
            .addConflict("conflict1")
            .setDeprecated("deprecated message")
            .build();

        String str = info.toString();
        
        assertThat(str).contains("pluginId='test-plugin'");
        assertThat(str).contains("version='1.2.3'");
        assertThat(str).contains("requiredPlugins=[dep1]");
        assertThat(str).contains("optionalPlugins=[opt1]");
        assertThat(str).contains("conflicts=[conflict1]");
        assertThat(str).contains("deprecated=true");
    }

    @Test
    @DisplayName("测试空操作的处理")
    void testEmptyOperationsHandling() {
        // 测试添加null值
        PluginVersionInfo info = builder1
            .addRequiredPlugin(null)
            .addOptionalPlugin("")
            .addMetadata(null, "value")
            .addMetadata("key", null)
            .addVersionConstraint(null, null)
            .addConflict("")
            .build();

        // 这些操作应该被忽略，不会导致异常
        assertThat(info).isNotNull();
        assertThat(info.getRequiredPlugins()).isEmpty();
        assertThat(info.getOptionalPlugins()).isEmpty();
        assertThat(info.getMetadata()).isEmpty();
        assertThat(info.getVersionConstraints()).isEmpty();
        assertThat(info.getConflicts()).isEmpty();
    }
}