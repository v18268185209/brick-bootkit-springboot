package com.zqzqq.bootkits.core.health;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import java.time.LocalDateTime;
import java.util.*;

import static org.assertj.core.api.Assertions.assertThat;

/**
 * 插件健康报告测试
 */
@DisplayName("PluginHealthReport Test")
class PluginHealthReportTest {

    private PluginHealthReport healthReport;

    @BeforeEach
    void setUp() {
        healthReport = new PluginHealthReport();
    }

    @Test
    @DisplayName("测试创建空的健康报告")
    void testEmptyHealthReport() {
        assertThat(healthReport.getOverallStatus()).isEqualTo(PluginHealthStatus.UNKNOWN);
        assertThat(healthReport.getCheckedAt()).isNotNull();
        assertThat(healthReport.getChecks()).isEmpty();
        assertThat(healthReport.getOverallStatus()).isNotNull();
    }

    @Test
    @DisplayName("测试添加健康检查项")
    void testAddHealthCheck() {
        PluginHealthStatus status1 = PluginHealthStatus.HEALTHY;
        PluginHealthStatus status2 = PluginHealthStatus.WARNING;

        healthReport.addCheck("memory-check", status1, "Memory usage normal");
        healthReport.addCheck("disk-check", status2, "Disk space low");

        assertThat(healthReport.getChecks()).hasSize(2);
        assertThat(healthReport.getChecks()).containsKeys("memory-check", "disk-check");
    }

    @Test
    @DisplayName("测试计算整体健康状态 - 全部健康")
    void testCalculateOverallStatusAllHealthy() {
        healthReport.addCheck("memory", PluginHealthStatus.HEALTHY, "OK");
        healthReport.addCheck("cpu", PluginHealthStatus.HEALTHY, "OK");
        healthReport.addCheck("disk", PluginHealthStatus.HEALTHY, "OK");

        PluginHealthStatus result = healthReport.getOverallStatus();
        assertThat(result).isEqualTo(PluginHealthStatus.HEALTHY);
    }

    @Test
    @DisplayName("测试计算整体健康状态 - 有警告")
    void testCalculateOverallStatusWithWarnings() {
        healthReport.addCheck("memory", PluginHealthStatus.HEALTHY, "OK");
        healthReport.addCheck("cpu", PluginHealthStatus.WARNING, "High CPU usage");
        healthReport.addCheck("disk", PluginHealthStatus.HEALTHY, "OK");

        PluginHealthStatus result = healthReport.getOverallStatus();
        assertThat(result).isEqualTo(PluginHealthStatus.WARNING);
    }

    @Test
    @DisplayName("测试计算整体健康状态 - 有关键错误")
    void testCalculateOverallStatusWithCritical() {
        healthReport.addCheck("memory", PluginHealthStatus.HEALTHY, "OK");
        healthReport.addCheck("cpu", PluginHealthStatus.CRITICAL, "CPU overload");
        healthReport.addCheck("disk", PluginHealthStatus.HEALTHY, "OK");

        PluginHealthStatus result = healthReport.getOverallStatus();
        assertThat(result).isEqualTo(PluginHealthStatus.CRITICAL);
    }

    @Test
    @DisplayName("测试计算整体健康状态 - 混合状态")
    void testCalculateOverallStatusMixed() {
        healthReport.addCheck("memory", PluginHealthStatus.WARNING, "Memory high");
        healthReport.addCheck("cpu", PluginHealthStatus.HEALTHY, "CPU normal");
        healthReport.addCheck("disk", PluginHealthStatus.UNKNOWN, "Disk unknown");

        PluginHealthStatus result = healthReport.getOverallStatus();
        assertThat(result).isEqualTo(PluginHealthStatus.WARNING); // 最高严重级别的状态
    }

    @Test
    @DisplayName("测试获取检查时间")
    void testGetCheckedAt() {
        LocalDateTime before = LocalDateTime.now();
        PluginHealthReport newReport = new PluginHealthReport();
        LocalDateTime after = LocalDateTime.now();

        assertThat(newReport.getCheckedAt()).isBetween(before, after);
    }

    @Test
    @DisplayName("测试检查项的详细状态")
    void testCheckItemDetails() {
        PluginHealthStatus status = PluginHealthStatus.HEALTHY;
        String checkName = "database";
        String message = "Database connection OK";

        healthReport.addCheck(checkName, status, message);

        Map<String, Object> checks = healthReport.getChecks();
        assertThat(checks).hasSize(1);

        Object checkObj = checks.get(checkName);
        assertThat(checkObj).isInstanceOf(Map.class);

        @SuppressWarnings("unchecked")
        Map<String, Object> checkDetails = (Map<String, Object>) checkObj;
        assertThat(checkDetails.get("status")).isEqualTo(status);
        assertThat(checkDetails.get("message")).isEqualTo(message);
    }

    @Test
    @DisplayName("测试空检查项时添加null")
    void testAddNullCheck() {
        // 当添加null检查时应该正常处理
        healthReport.addCheck(null, PluginHealthStatus.UNKNOWN, "Null check");
        assertThat(healthReport.getChecks()).hasSize(1);
    }

    @Test
    @DisplayName("测试检查项覆盖")
    void testCheckItemOverride() {
        String checkName = "test-check";
        
        healthReport.addCheck(checkName, PluginHealthStatus.HEALTHY, "First status");
        healthReport.addCheck(checkName, PluginHealthStatus.CRITICAL, "Second status");
        
        // 后添加的检查应该覆盖前面的
        assertThat(healthReport.getChecks()).hasSize(1);
        
        @SuppressWarnings("unchecked")
        Map<String, Object> checkDetails = (Map<String, Object>) healthReport.getChecks().get(checkName);
        assertThat(checkDetails.get("status")).isEqualTo(PluginHealthStatus.CRITICAL);
        assertThat(checkDetails.get("message")).isEqualTo("Second status");
    }

    @Test
    @DisplayName("测试性能 - 大量检查项的性能")
    void testPerformanceWithManyChecks() {
        for (int i = 0; i < 1000; i++) {
            healthReport.addCheck("check-" + i, PluginHealthStatus.HEALTHY, "OK");
        }

        assertThat(healthReport.getChecks()).hasSize(1000);
        assertThat(healthReport.getOverallStatus()).isEqualTo(PluginHealthStatus.HEALTHY);
    }

    @Test
    @DisplayName("测试不可变集合")
    void testUnmodifiableCollection() {
        healthReport.addCheck("test", PluginHealthStatus.HEALTHY, "OK");
        
        Map<String, Object> checks = healthReport.getChecks();
        
        // 尝试直接修改集合应该失败
        assertThatThrownBy(() -> checks.put("new-test", "value"))
            .isInstanceOf(UnsupportedOperationException.class);
    }
}