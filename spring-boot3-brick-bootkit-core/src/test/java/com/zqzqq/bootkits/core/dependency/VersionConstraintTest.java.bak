package com.zqzqq.bootkits.core.dependency;

import com.zqzqq.bootkits.core.dependency.VersionConstraint.ConstraintOperator;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;

/**
 * 版本约束测试
 */
@DisplayName("VersionConstraint Test")
class VersionConstraintTest {

    @Test
    @DisplayName("测试解析简单版本约束")
    void testParseSimpleVersionConstraints() {
        // 测试等于约束
        VersionConstraint equals = VersionConstraint.parse("=1.2.3");
        assertThat(equals.getOperator()).isEqualTo(ConstraintOperator.EQUALS);
        assertThat(equals.getVersion()).isEqualTo("1.2.3");
        assertThat(equals.isRange()).isFalse();

        // 测试大于约束
        VersionConstraint greater = VersionConstraint.parse(">1.0.0");
        assertThat(greater.getOperator()).isEqualTo(ConstraintOperator.GREATER_THAN);
        assertThat(greater.getVersion()).isEqualTo("1.0.0");

        // 测试大于等于约束
        VersionConstraint greaterEqual = VersionConstraint.parse(">=2.0.0");
        assertThat(greaterEqual.getOperator()).isEqualTo(ConstraintOperator.GREATER_THAN_EQUAL);
        assertThat(greaterEqual.getVersion()).isEqualTo("2.0.0");

        // 测试小于约束
        VersionConstraint less = VersionConstraint.parse("<3.0.0");
        assertThat(less.getOperator()).isEqualTo(ConstraintOperator.LESS_THAN);
        assertThat(less.getVersion()).isEqualTo("3.0.0");

        // 测试小于等于约束
        VersionConstraint lessEqual = VersionConstraint.parse("<=1.5.0");
        assertThat(lessEqual.getOperator()).isEqualTo(ConstraintOperator.LESS_THAN_EQUAL);
        assertThat(lessEqual.getVersion()).isEqualTo("1.5.0");
    }

    @Test
    @DisplayName("测试解析范围约束")
    void testParseRangeConstraints() {
        // 测试包含下界和上界的范围
        VersionConstraint range1 = VersionConstraint.parse("[1.0.0,2.0.0)");
        assertThat(range1.isRange()).isTrue();
        assertThat(range1.getLowerBound()).isEqualTo("1.0.0");
        assertThat(range1.getUpperBound()).isEqualTo("2.0.0");
        assertThat(range1.getOperator()).isNull(); // 范围约束没有操作符

        // 测试另一种范围格式
        VersionConstraint range2 = VersionConstraint.parse("(0.5.0,3.0.0]");
        assertThat(range2.isRange()).isTrue();
        assertThat(range2.getLowerBound()).isEqualTo("0.5.0");
        assertThat(range2.getUpperBound()).isEqualTo("3.0.0");
    }

    @Test
    @DisplayName("测试无效约束格式")
    void testInvalidConstraintFormats() {
        assertThatThrownBy(() -> VersionConstraint.parse(null))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessage("版本约束不能为空");

        assertThatThrownBy(() -> VersionConstraint.parse(""))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessage("版本约束不能为空");

        assertThatThrownBy(() -> VersionConstraint.parse("   "))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessage("版本约束不能为空");

        assertThatThrownBy(() -> VersionConstraint.parse("invalid"))
            .isInstanceOf(IllegalArgumentException.class);

        assertThatThrownBy(() -> VersionConstraint.parse("[invalid]"))
            .isInstanceOf(IllegalArgumentException.class);

        assertThatThrownBy(() -> VersionConstraint.parse("[1.0.0"))
            .isInstanceOf(IllegalArgumentException.class);

        assertThatThrownBy(() -> VersionConstraint.parse("1.0.0]"))
            .isInstanceOf(IllegalArgumentException.class);
    }

    @Test
    @DisplayName("测试版本约束满足检查")
    void testVersionConstraintSatisfaction() {
        // 测试等于约束
        VersionConstraint equals = VersionConstraint.parse("=1.2.3");
        assertThat(equals.isSatisfied("1.2.3")).isTrue();
        assertThat(equals.isSatisfied("1.2.4")).isFalse();
        assertThat(equals.isSatisfied("1.1.0")).isFalse();

        // 测试大于约束
        VersionConstraint greater = VersionConstraint.parse(">1.0.0");
        assertThat(greater.isSatisfied("1.0.1")).isTrue();
        assertThat(greater.isSatisfied("1.0.0")).isFalse();
        assertThat(greater.isSatisfied("0.9.9")).isFalse();

        // 测试大于等于约束
        VersionConstraint greaterEqual = VersionConstraint.parse(">=2.0.0");
        assertThat(greaterEqual.isSatisfied("2.0.0")).isTrue();
        assertThat(greaterEqual.isSatisfied("2.0.1")).isTrue();
        assertThat(greaterEqual.isSatisfied("1.9.9")).isFalse();

        // 测试小于约束
        VersionConstraint less = VersionConstraint.parse("<3.0.0");
        assertThat(less.isSatisfied("2.9.9")).isTrue();
        assertThat(less.isSatisfied("3.0.0")).isFalse();
        assertThat(less.isSatisfied("3.0.1")).isFalse();

        // 测试小于等于约束
        VersionConstraint lessEqual = VersionConstraint.parse("<=1.5.0");
        assertThat(lessEqual.isSatisfied("1.5.0")).isTrue();
        assertThat(lessEqual.isSatisfied("1.4.9")).isTrue();
        assertThat(lessEqual.isSatisfied("1.5.1")).isFalse();
    }

    @Test
    @DisplayName("测试范围约束满足检查")
    void testRangeConstraintSatisfaction() {
        // 测试闭区间范围 [1.0.0,2.0.0)
        VersionConstraint range = VersionConstraint.parse("[1.0.0,2.0.0)");
        
        // 在范围内
        assertThat(range.isSatisfied("1.0.0")).isTrue(); // 下界包含
        assertThat(range.isSatisfied("1.5.0")).isTrue();
        assertThat(range.isSatisfied("1.9.9")).isTrue();
        
        // 不在范围内
        assertThat(range.isSatisfied("0.9.9")).isFalse(); // 小于下界
        assertThat(range.isSatisfied("2.0.0")).isFalse(); // 等于上界（不包含）
        assertThat(range.isSatisfied("2.0.1")).isFalse(); // 大于上界

        // 测试开区间范围 (1.0.0,2.0.0]
        VersionConstraint openRange = VersionConstraint.parse("(1.0.0,2.0.0]");
        
        assertThat(openRange.isSatisfied("1.0.0")).isFalse(); // 不包含下界
        assertThat(openRange.isSatisfied("1.0.1")).isTrue();
        assertThat(openRange.isSatisfied("2.0.0")).isTrue(); // 包含上界
        assertThat(openRange.isSatisfied("2.0.1")).isFalse();

        // 测试完全开区间 (1.0.0,2.0.0)
        VersionConstraint fullyOpenRange = VersionConstraint.parse("(1.0.0,2.0.0)");
        
        assertThat(fullyOpenRange.isSatisfied("1.0.0")).isFalse();
        assertThat(fullyOpenRange.isSatisfied("1.0.1")).isTrue();
        assertThat(fullyOpenRange.isSatisfied("1.9.9")).isTrue();
        assertThat(fullyOpenRange.isSatisfied("2.0.0")).isFalse();
    }

    @Test
    @DisplayName("测试null和空版本检查")
    void testNullAndEmptyVersionCheck() {
        VersionConstraint constraint = VersionConstraint.parse(">=1.0.0");
        
        assertThat(constraint.isSatisfied(null)).isFalse();
        assertThat(constraint.isSatisfied("")).isFalse();
        assertThat(constraint.isSatisfied("   ")).isFalse();
    }

    @Test
    @DisplayName("测试版本约束操作符枚举")
    void testConstraintOperatorEnum() {
        assertThat(ConstraintOperator.EQUALS.getSymbol()).isEqualTo("=");
        assertThat(ConstraintOperator.EQUALS.getDescription()).isEqualTo("等于");
        assertThat(ConstraintOperator.EQUALS.toString()).isEqualTo("= (等于)");

        assertThat(ConstraintOperator.GREATER_THAN.getSymbol()).isEqualTo(">");
        assertThat(ConstraintOperator.GREATER_THAN.getDescription()).isEqualTo("大于");
        
        assertThat(ConstraintOperator.LESS_THAN_EQUAL.getSymbol()).isEqualTo("<=");
        assertThat(ConstraintOperator.LESS_THAN_EQUAL.getDescription()).isEqualTo("小于等于");
    }

    @Test
    @DisplayName("测试操作符字符串解析")
    void testOperatorStringParsing() {
        assertThat(ConstraintOperator.fromString("=")).isEqualTo(ConstraintOperator.EQUALS);
        assertThat(ConstraintOperator.fromString(">")).isEqualTo(ConstraintOperator.GREATER_THAN);
        assertThat(ConstraintOperator.fromString(">=")).isEqualTo(ConstraintOperator.GREATER_THAN_EQUAL);
        assertThat(ConstraintOperator.fromString("<")).isEqualTo(ConstraintOperator.LESS_THAN);
        assertThat(ConstraintOperator.fromString("<=")).isEqualTo(ConstraintOperator.LESS_THAN_EQUAL);

        assertThatThrownBy(() -> ConstraintOperator.fromString("invalid"))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessage("未知的版本操作符: invalid");
    }

    @Test
    @DisplayName("测试toString方法")
    void testToString() {
        VersionConstraint constraint1 = VersionConstraint.parse(">=1.0.0");
        assertThat(constraint1.toString()).isEqualTo(">=1.0.0");

        VersionConstraint constraint2 = VersionConstraint.parse("[1.0.0,2.0.0)");
        assertThat(constraint2.toString()).isEqualTo("[1.0.0,2.0.0)");

        VersionConstraint constraint3 = VersionConstraint.parse("<3.0.0");
        assertThat(constraint3.toString()).isEqualTo("<3.0.0");
    }

    @Test
    @DisplayName("测试复杂版本号约束")
    void testComplexVersionConstraints() {
        // 测试预发布版本约束
        VersionConstraint prerelease = VersionConstraint.parse(">=2.0.0-alpha.1");
        assertThat(prerelease.isSatisfied("2.0.0-alpha.1")).isTrue();
        assertThat(prerelease.isSatisfied("2.0.0-alpha.2")).isTrue();
        assertThat(prerelease.isSatisfied("2.0.0-beta.1")).isTrue();
        assertThat(prerelease.isSatisfied("2.0.0")).isTrue();
        assertThat(prerelease.isSatisfied("1.9.9")).isFalse();

        // 测试复杂版本号约束
        VersionConstraint complex = VersionConstraint.parse(">1.2.3-beta.4");
        assertThat(complex.isSatisfied("1.2.3-beta.5")).isTrue();
        assertThat(complex.isSatisfied("1.2.3-rc.1")).isTrue();
        assertThat(complex.isSatisfied("1.2.3-beta.4")).isFalse(); // 不大于
        assertThat(complex.isSatisfied("1.2.3-alpha.5")).isFalse();
    }

    @Test
    @DisplayName("测试边界情况")
    void testEdgeCases() {
        // 测试零版本
        VersionConstraint zero = VersionConstraint.parse(">=0.0.0");
        assertThat(zero.isSatisfied("0.0.0")).isTrue();
        assertThat(zero.isSatisfied("0.0.1")).isTrue();

        // 测试大版本号
        VersionConstraint large = VersionConstraint.parse("<=999.999.999");
        assertThat(large.isSatisfied("999.999.999")).isTrue();
        assertThat(large.isSatisfied("1000.0.0")).isFalse();

        // 测试单数字版本
        VersionConstraint singleDigit = VersionConstraint.parse(">1");
        assertThat(singleDigit.isSatisfied("1.0.0")).isTrue();
        assertThat(singleDigit.isSatisfied("1")).isTrue();
        assertThat(singleDigit.isSatisfied("0.9.9")).isFalse();
    }

    @Test
    @DisplayName("测试范围约束边界解析")
    void testRangeBoundaryParsing() {
        // 测试带操作符的边界
        VersionConstraint range1 = VersionConstraint.parse("[>=1.0.0,<3.0.0)");
        assertThat(range1.isRange()).isTrue();
        assertThat(range1.getLowerBound()).isEqualTo("1.0.0");
        assertThat(range1.getUpperBound()).isEqualTo("3.0.0");

        // 测试无操作符的边界
        VersionConstraint range2 = VersionConstraint.parse("[1.0.0,3.0.0)");
        assertThat(range2.isRange()).isTrue();
        assertThat(range2.getLowerBound()).isEqualTo("1.0.0");
        assertThat(range2.getUpperBound()).isEqualTo("3.0.0");
    }

    @Test
    @DisplayName("测试约束对象不可变性")
    void testConstraintImmutability() {
        VersionConstraint constraint = VersionConstraint.parse(">=1.0.0");
        
        // 获取内部字段应该返回原始值，不能被修改
        assertThat(constraint.getOriginalConstraint()).isEqualTo(">=1.0.0");
        assertThat(constraint.getOperator()).isEqualTo(ConstraintOperator.GREATER_THAN_EQUAL);
        assertThat(constraint.getVersion()).isEqualTo("1.0.0");
        assertThat(constraint.isRange()).isFalse();
    }

    @Test
    @DisplayName("测试多版本约束组合")
    void testMultipleVersionConstraintCombinations() {
        String[] constraints = {
            "=1.0.0",
            "!=2.0.0",
            ">1.0.0",
            ">=1.0.0",
            "<2.0.0",
            "<=1.5.0",
            "[1.0.0,2.0.0)",
            "(1.0.0,2.0.0]",
            "(1.0.0,2.0.0)"
        };

        for (String constraintStr : constraints) {
            VersionConstraint constraint = VersionConstraint.parse(constraintStr);
            assertThat(constraint).isNotNull();
            assertThat(constraint.getOriginalConstraint()).isEqualTo(constraintStr);
        }
    }

    @Test
    @DisplayName("测试约束版本号格式验证")
    void testConstraintVersionFormatValidation() {
        // 测试各种版本格式
        VersionConstraint v1 = VersionConstraint.parse(">=1.2.3");
        assertThat(v1.getVersion()).isEqualTo("1.2.3");

        VersionConstraint v2 = VersionConstraint.parse(">1.2");
        assertThat(v2.getVersion()).isEqualTo("1.2");

        VersionConstraint v3 = VersionConstraint.parse("<1");
        assertThat(v3.getVersion()).isEqualTo("1");

        VersionConstraint v4 = VersionConstraint.parse("<=1.2.3-alpha.1");
        assertThat(v4.getVersion()).isEqualTo("1.2.3-alpha.1");
    }

    @Test
    @DisplayName("测试操作符优先级")
    void testOperatorPrecedence() {
        // 测试不同操作符的比较结果
        VersionConstraint equals = VersionConstraint.parse("=1.0.0");
        VersionConstraint greater = VersionConstraint.parse(">1.0.0");
        VersionConstraint greaterEqual = VersionConstraint.parse(">=1.0.0");

        // 对于版本1.0.0
        assertThat(equals.isSatisfied("1.0.0")).isTrue();
        assertThat(greater.isSatisfied("1.0.0")).isFalse();
        assertThat(greaterEqual.isSatisfied("1.0.0")).isTrue();

        // 对于版本1.0.1
        assertThat(equals.isSatisfied("1.0.1")).isFalse();
        assertThat(greater.isSatisfied("1.0.1")).isTrue();
        assertThat(greaterEqual.isSatisfied("1.0.1")).isTrue();
    }

    @Test
    @DisplayName("测试空格处理")
    void testWhitespaceHandling() {
        // 测试带空格的约束
        VersionConstraint withSpaces = VersionConstraint.parse(">= 1.0.0");
        assertThat(withSpaces.getOperator()).isEqualTo(ConstraintOperator.GREATER_THAN_EQUAL);
        assertThat(withSpaces.getVersion()).isEqualTo("1.0.0");

        // 测试范围中的空格
        VersionConstraint rangeWithSpaces = VersionConstraint.parse("[ 1.0.0 , 2.0.0 )");
        assertThat(rangeWithSpaces.isRange()).isTrue();
        assertThat(rangeWithSpaces.getLowerBound()).isEqualTo("1.0.0");
        assertThat(rangeWithSpaces.getUpperBound()).isEqualTo("2.0.0");
    }
}